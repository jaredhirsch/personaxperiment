<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>
.btn { background: #65a9d7; padding: 5px 10px; width: 100px; box-shadow: rgba(0,0,0,1) 0 1px 0; }
.btn.disabled { background: grey; }
.btn:hover { cursor: pointer; }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
</head>
<body data-appy-state="initializing">
<div class="btn login disabled">log in</div>
<p>status: <span class="user-status">initializing</span>
<script>

// possible app states: 'initializing', 'loggedOut', 'loggingIn', 'loggedIn'

$(document).ready(function() {
    $(document).on('stateChanged', function(e, newState) {
        $('body').data('appy-state', newState);
        localStorage.setItem('appy-state', newState)

        $('.btn.login')
            .removeClass('loggedOut loggingIn loggedIn initializing disabled')
            .addClass(newState);

        if (newState == 'loggingIn') {
            $('.btn.login').addClass('disabled');
            // to simulate server action, just set a timer
            setTimeout(function() { $(document).trigger('stateChanged', 'loggedIn') }, 500);
        }

        // ex: loggedOut --> "logged out"
        var stateText = newState.replace(/[A-Z]/, function(a,x,y) { return a.replace(a, ' '+y[x].toLowerCase()) });
        $('.user-status').text(stateText);

        if (newState == 'loggedIn') { $('.btn.login').text('log out') }
        if (newState == 'loggedOut') { $('.btn.login').text('log in') }
    });

    $(document).on('click', '.btn.login', function(e) { 
        if ($(this).hasClass('disabled')) { return; }
        var appyState = $('body').data('appy-state');
        if (appyState == 'loggedOut') { $(this).trigger('stateChanged', 'loggingIn'); } 
        if (appyState == 'loggedIn') { $(this).trigger('stateChanged', 'loggedOut'); }
    });

    // on init, fetch the last known state from localStorage
    var cachedState = localStorage.getItem('appy-state') || 'loggedOut';
    console.log(cachedState);
    $(document).trigger('stateChanged', cachedState); 

});
</script>
</body>
</html>
